{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between">
            <h2>Hero Database Management</h2>
            <div>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-home me-2"></i>Back to Home
                </a>
                <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#addHeroModal">
                    <i class="fas fa-plus me-2"></i>Add New Hero
                </button>
            </div>
        </div>
        <hr>
    </div>

    {% if message %}
    <div class="col-12 mb-4">
        <div class="alert alert-{{ message_type }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
    {% endif %}

    <!-- Hero Database Table -->
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Heroes Database</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Basic Attributes</th>
                                <th>Performance Stats</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hero in heroes %}
                            <tr>
                                <td>{{ hero.id }}</td>
                                <td><strong>{{ hero.name }}</strong></td>
                                <td><span class="badge bg-secondary">{{ hero.role }}</span></td>
                                <td>
                                    <small>DMG: {{ hero.damage }}</small>,
                                    <small>DUR: {{ hero.durability }}</small>,
                                    <small>CC: {{ hero.crowd_control }}</small>,
                                    <small>MOB: {{ hero.mobility }}</small>,
                                    <small>DIFF: {{ hero.difficulty }}</small>
                                </td>
                                <td>
                                    <small>WR: {{ hero.win_rate }}%</small>,
                                    <small>PF: {{ hero.profit_factor }}</small>,
                                    <small>DD: {{ hero.max_drawdown }}%</small>,
                                    <small>CL: {{ hero.max_consecutive_loss }}</small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info edit-hero-btn" data-hero-id="{{ hero.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-hero-btn" data-hero-id="{{ hero.id }}" data-hero-name="{{ hero.name }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Hero Modal -->
<div class="modal fade" id="addHeroModal" tabindex="-1" aria-labelledby="addHeroModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="addHeroModalLabel">Add New Hero</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addHeroForm" class="needs-validation" novalidate>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Hero Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                            <div class="invalid-feedback">
                                Please provide a hero name.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="role" class="form-label">Role</label>
                            <select class="form-select" id="role" name="role" required>
                                <option value="" selected disabled>Select role...</option>
                                <option value="Tank">Tank</option>
                                <option value="Fighter">Fighter</option>
                                <option value="Assassin">Assassin</option>
                                <option value="Mage">Mage</option>
                                <option value="Marksman">Marksman</option>
                                <option value="Support">Support</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a role.
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <h5>Basic Attributes</h5>
                        <div class="col-md-4 mb-2">
                            <label for="damage" class="form-label">Damage (1-10)</label>
                            <input type="range" class="form-range" id="damage" name="damage" min="1" max="10" value="5">
                            <div class="text-center" id="damageValue">5</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="durability" class="form-label">Durability (1-10)</label>
                            <input type="range" class="form-range" id="durability" name="durability" min="1" max="10" value="5">
                            <div class="text-center" id="durabilityValue">5</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="crowd_control" class="form-label">Crowd Control (1-10)</label>
                            <input type="range" class="form-range" id="crowd_control" name="crowd_control" min="1" max="10" value="5">
                            <div class="text-center" id="crowdControlValue">5</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="mobility" class="form-label">Mobility (1-10)</label>
                            <input type="range" class="form-range" id="mobility" name="mobility" min="1" max="10" value="5">
                            <div class="text-center" id="mobilityValue">5</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="difficulty" class="form-label">Difficulty (1-10)</label>
                            <input type="range" class="form-range" id="difficulty" name="difficulty" min="1" max="10" value="5">
                            <div class="text-center" id="difficultyValue">5</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <h5>Performance Statistics</h5>
                        <div class="col-md-6 mb-2">
                            <label for="win_rate" class="form-label">Win Rate (%)</label>
                            <input type="number" class="form-control" id="win_rate" name="win_rate" min="0" max="100" value="50">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="profit_factor" class="form-label">Profit Factor</label>
                            <input type="number" class="form-control" id="profit_factor" name="profit_factor" min="0" step="0.1" value="1.0">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="max_drawdown" class="form-label">Max Drawdown (%)</label>
                            <input type="number" class="form-control" id="max_drawdown" name="max_drawdown" min="0" max="100" value="20">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="max_consecutive_loss" class="form-label">Max Consecutive Loss</label>
                            <input type="number" class="form-control" id="max_consecutive_loss" name="max_consecutive_loss" min="0" value="3">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="strengths" class="form-label">Strengths (one per line)</label>
                            <textarea class="form-control" id="strengths" name="strengths" rows="4" placeholder="Enter one strength per line"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="weaknesses" class="form-label">Weaknesses (one per line)</label>
                            <textarea class="form-control" id="weaknesses" name="weaknesses" rows="4" placeholder="Enter one weakness per line"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveNewHeroBtn">Save Hero</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Hero Modal -->
<div class="modal fade" id="editHeroModal" tabindex="-1" aria-labelledby="editHeroModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="editHeroModalLabel">Edit Hero</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editHeroForm" class="needs-validation" novalidate>
                    <input type="hidden" id="edit_hero_id" name="hero_id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_name" class="form-label">Hero Name</label>
                            <input type="text" class="form-control" id="edit_name" name="name" required>
                            <div class="invalid-feedback">
                                Please provide a hero name.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_role" class="form-label">Role</label>
                            <select class="form-select" id="edit_role" name="role" required>
                                <option value="" selected disabled>Select role...</option>
                                <option value="Tank">Tank</option>
                                <option value="Fighter">Fighter</option>
                                <option value="Assassin">Assassin</option>
                                <option value="Mage">Mage</option>
                                <option value="Marksman">Marksman</option>
                                <option value="Support">Support</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a role.
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <h5>Basic Attributes</h5>
                        <div class="col-md-4 mb-2">
                            <label for="edit_damage" class="form-label">Damage (1-10)</label>
                            <input type="range" class="form-range" id="edit_damage" name="damage" min="1" max="10" value="5">
                            <div class="text-center" id="edit_damageValue">5</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="edit_durability" class="form-label">Durability (1-10)</label>
                            <input type="range" class="form-range" id="edit_durability" name="durability" min="1" max="10" value="5">
                            <div class="text-center" id="edit_durabilityValue">5</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="edit_crowd_control" class="form-label">Crowd Control (1-10)</label>
                            <input type="range" class="form-range" id="edit_crowd_control" name="crowd_control" min="1" max="10" value="5">
                            <div class="text-center" id="edit_crowdControlValue">5</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="edit_mobility" class="form-label">Mobility (1-10)</label>
                            <input type="range" class="form-range" id="edit_mobility" name="mobility" min="1" max="10" value="5">
                            <div class="text-center" id="edit_mobilityValue">5</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="edit_difficulty" class="form-label">Difficulty (1-10)</label>
                            <input type="range" class="form-range" id="edit_difficulty" name="difficulty" min="1" max="10" value="5">
                            <div class="text-center" id="edit_difficultyValue">5</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <h5>Performance Statistics</h5>
                        <div class="col-md-6 mb-2">
                            <label for="edit_win_rate" class="form-label">Win Rate (%)</label>
                            <input type="number" class="form-control" id="edit_win_rate" name="win_rate" min="0" max="100" value="50">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="edit_profit_factor" class="form-label">Profit Factor</label>
                            <input type="number" class="form-control" id="edit_profit_factor" name="profit_factor" min="0" step="0.1" value="1.0">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="edit_max_drawdown" class="form-label">Max Drawdown (%)</label>
                            <input type="number" class="form-control" id="edit_max_drawdown" name="max_drawdown" min="0" max="100" value="20">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="edit_max_consecutive_loss" class="form-label">Max Consecutive Loss</label>
                            <input type="number" class="form-control" id="edit_max_consecutive_loss" name="max_consecutive_loss" min="0" value="3">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_strengths" class="form-label">Strengths (one per line)</label>
                            <textarea class="form-control" id="edit_strengths" name="strengths" rows="4" placeholder="Enter one strength per line"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_weaknesses" class="form-label">Weaknesses (one per line)</label>
                            <textarea class="form-control" id="edit_weaknesses" name="weaknesses" rows="4" placeholder="Enter one weakness per line"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="updateHeroBtn">Update Hero</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Hero Confirmation Modal -->
<div class="modal fade" id="deleteHeroModal" tabindex="-1" aria-labelledby="deleteHeroModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteHeroModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete hero <strong id="deleteHeroName"></strong>?</p>
                <p>This action cannot be undone.</p>
                <input type="hidden" id="deleteHeroId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
    
    // Range sliders update value display
    const rangeInputs = document.querySelectorAll('input[type="range"]');
    rangeInputs.forEach(input => {
        const valueDisplay = document.getElementById(`${input.id}Value`);
        if (valueDisplay) {
            valueDisplay.textContent = input.value;
            input.addEventListener('input', () => {
                valueDisplay.textContent = input.value;
            });
        }
    });
    
    // Add hero form submission
    const saveNewHeroBtn = document.getElementById('saveNewHeroBtn');
    if (saveNewHeroBtn) {
        saveNewHeroBtn.addEventListener('click', () => {
            const form = document.getElementById('addHeroForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            const formData = new FormData(form);
            const heroData = {};
            
            for (const [key, value] of formData.entries()) {
                if (key === 'strengths' || key === 'weaknesses') {
                    // Split by newline and filter out empty lines
                    heroData[key] = value.split('\n').filter(line => line.trim() !== '');
                } else if (['damage', 'durability', 'crowd_control', 'mobility', 'difficulty', 'win_rate', 'max_drawdown', 'max_consecutive_loss'].includes(key)) {
                    // Convert numeric values to numbers
                    heroData[key] = parseInt(value, 10);
                } else if (key === 'profit_factor') {
                    // Convert to float
                    heroData[key] = parseFloat(value);
                } else {
                    heroData[key] = value;
                }
            }
            
            // Send request to API
            fetch('/api/heroes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(heroData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to add hero');
                }
                return response.json();
            })
            .then(data => {
                // Success! Reload the page
                window.location.href = '/admin?message=Hero added successfully!&type=success';
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            });
        });
    }
    
    // Edit hero button click
    const editHeroBtns = document.querySelectorAll('.edit-hero-btn');
    editHeroBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const heroId = btn.getAttribute('data-hero-id');
            
            // Fetch hero data
            fetch(`/api/heroes/${heroId}`)
            .then(response => response.json())
            .then(hero => {
                // Populate form
                document.getElementById('edit_hero_id').value = hero.id;
                document.getElementById('edit_name').value = hero.name;
                document.getElementById('edit_role').value = hero.role;
                document.getElementById('edit_description').value = hero.description || '';
                
                // Set attributes
                document.getElementById('edit_damage').value = hero.damage;
                document.getElementById('edit_durability').value = hero.durability;
                document.getElementById('edit_crowd_control').value = hero.crowd_control;
                document.getElementById('edit_mobility').value = hero.mobility;
                document.getElementById('edit_difficulty').value = hero.difficulty;
                
                // Update value displays
                document.getElementById('edit_damageValue').textContent = hero.damage;
                document.getElementById('edit_durabilityValue').textContent = hero.durability;
                document.getElementById('edit_crowdControlValue').textContent = hero.crowd_control;
                document.getElementById('edit_mobilityValue').textContent = hero.mobility;
                document.getElementById('edit_difficultyValue').textContent = hero.difficulty;
                
                // Set statistics
                document.getElementById('edit_win_rate').value = hero.win_rate;
                document.getElementById('edit_profit_factor').value = hero.profit_factor;
                document.getElementById('edit_max_drawdown').value = hero.max_drawdown;
                document.getElementById('edit_max_consecutive_loss').value = hero.max_consecutive_loss;
                
                // Set strengths and weaknesses
                document.getElementById('edit_strengths').value = hero.strengths.join('\n');
                document.getElementById('edit_weaknesses').value = hero.weaknesses.join('\n');
                
                // Show modal
                const editModal = new bootstrap.Modal(document.getElementById('editHeroModal'));
                editModal.show();
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            });
        });
    });
    
    // Update hero button click
    const updateHeroBtn = document.getElementById('updateHeroBtn');
    if (updateHeroBtn) {
        updateHeroBtn.addEventListener('click', () => {
            const form = document.getElementById('editHeroForm');
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            const heroId = document.getElementById('edit_hero_id').value;
            const formData = new FormData(form);
            const heroData = {};
            
            for (const [key, value] of formData.entries()) {
                if (key === 'hero_id') continue;
                
                if (key === 'strengths' || key === 'weaknesses') {
                    // Split by newline and filter out empty lines
                    heroData[key] = value.split('\n').filter(line => line.trim() !== '');
                } else if (['damage', 'durability', 'crowd_control', 'mobility', 'difficulty', 'win_rate', 'max_drawdown', 'max_consecutive_loss'].includes(key)) {
                    // Convert numeric values to numbers
                    heroData[key] = parseInt(value, 10);
                } else if (key === 'profit_factor') {
                    // Convert to float
                    heroData[key] = parseFloat(value);
                } else {
                    heroData[key] = value;
                }
            }
            
            // Send request to API
            fetch(`/api/heroes/${heroId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(heroData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update hero');
                }
                return response.json();
            })
            .then(data => {
                // Success! Reload the page
                window.location.href = '/admin?message=Hero updated successfully!&type=success';
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            });
        });
    }
    
    // Delete hero button click
    const deleteHeroBtns = document.querySelectorAll('.delete-hero-btn');
    deleteHeroBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const heroId = btn.getAttribute('data-hero-id');
            const heroName = btn.getAttribute('data-hero-name');
            
            document.getElementById('deleteHeroId').value = heroId;
            document.getElementById('deleteHeroName').textContent = heroName;
            
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteHeroModal'));
            deleteModal.show();
        });
    });
    
    // Confirm delete button click
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', () => {
            const heroId = document.getElementById('deleteHeroId').value;
            
            // Send delete request to API
            fetch(`/api/heroes/${heroId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete hero');
                }
                return response.json();
            })
            .then(data => {
                // Success! Reload the page
                window.location.href = '/admin?message=Hero deleted successfully!&type=success';
            })
            .catch(error => {
                alert(`Error: ${error.message}`);
            });
        });
    }
});
</script>
{% endblock %}